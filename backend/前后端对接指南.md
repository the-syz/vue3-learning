# 前后端对接指南

本文档介绍如何在前端项目中配置和使用FastAPI后端API，以及如何从使用mock数据逐步切换到真实后端API。

## 后端项目结构

```
backend/
├── .env            # 环境变量配置
├── main.py         # 主程序文件（应用初始化和配置）
├── database.py     # 数据库相关代码（模型定义和配置）
├── api.py          # API端点实现
├── requirements.txt # 项目依赖
└── 前后端对接指南.md # 对接说明
```

### 文件说明
- **main.py**: 主程序文件，负责应用初始化、CORS配置和整合其他模块
- **database.py**: 数据库相关代码，包含数据库模型定义、连接配置和初始化数据逻辑
- **api.py**: API端点实现，包含所有业务逻辑和API路由

## 启动后端服务器

1. 首先确保已安装所有依赖：

```bash
cd h:\vue3_learning\backend
pip install -r requirements.txt
```

2. 启动FastAPI服务器：

```bash
# 方法一：直接运行 main.py
python main.py

# 方法二：使用 uvicorn 命令
uvicorn main:app --reload --host 127.0.0.1 --port 8000
```

后端服务器将在 `http://127.0.0.1:8000` 上运行。

## 前端配置

### 1. 配置后端API地址

前端项目的后端API地址配置位于 `src/config/index.js` 文件中：

```javascript
export const EnvConfig = {
  development: {
    baseApi: '/api',
    mockApi: '/api',
    backendApi: 'http://127.0.0.1:8000/api' // FastAPI后端API地址
  },
  // 其他环境配置...
}
```

你可以根据实际情况修改 `backendApi` 的值。

### 2. 切换mock数据和后端API

在 `src/config/index.js` 文件中，有两个关键配置：

```javascript
export default {
  env,
  ...EnvConfig[env],
  useBackend: true, // 当前配置：true使用后端API，false使用mock数据
  mock:true, // 是否启用mock数据拦截功能
};
```

- **全局切换**：修改 `useBackend` 的值为 `true` 或 `false`
- **局部切换**：在每个API请求中，可以单独设置 `useBackend` 参数，覆盖全局配置

## 当前配置状态

目前前端项目已配置为直接连接后端API：

```javascript
// 当前配置
useBackend: true, // 使用后端实际API地址
mock: true, // 保留mock数据拦截功能
```

## 后端API请求流程

当前前端项目的API请求流程如下：

1. 通过 `src/api/api.js` 定义所有接口请求方法
2. 使用 `src/api/request.js` 封装的axios请求，根据 `useBackend` 和 `mock` 配置决定请求方式
3. 请求优先通过 `src/api/mock.js` 配置的Mock拦截规则处理
4. 如果未拦截，则通过配置的 `backendApi` 地址（`http://127.0.0.1:8000/api`）向后端发送实际请求
5. API被全局挂载到Vue原型上，可通过 `this.$api` 访问

## 数据存储更新

1. **ChartData表初始化**：数据库初始化时会自动生成并存储三种图表数据（orderData、videoData、userData）
2. **用户数据改进**：
   - 用户地址现仅包含省市信息
   - 所有用户（包括随机生成的用户）都会随机分配给现有员工账户
3. **账户系统**：系统包含1个管理员账户和3个普通员工账户，权限分配已通过多对多关系实现
```

### 步骤3：全局切换到后端API

当所有接口调试完成后，可以全局切换到后端API：

```javascript
// src/config/index.js
useBackend: true
```

## 已实现的API端点

后端已实现以下API端点，与前端mock数据结构完全匹配：

### Home相关
- `GET /api/home/getTableData` - 获取表格数据
- `GET /api/home/getCountData` - 获取统计数据
- `GET /api/home/getChartData` - 获取图表数据

### User相关
- `GET /api/user/getUserData` - 获取用户列表（支持分页和搜索）
- `DELETE /api/user/deleteUser` - 删除用户
- `POST /api/user/addUser` - 添加用户
- `PUT /api/user/editUser` - 编辑用户

### Permission相关
- `POST /api/permission/getMenu` - 获取菜单权限

## 后端数据库

后端使用MySQL数据库，使用前需要先创建数据库：

1. 登录MySQL：
   ```bash
   mysql -u root -p
   ```

2. 创建数据库：
   ```sql
   CREATE DATABASE vue3_project CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

3. 修改 `.env` 文件中的数据库配置：
   ```
   DB_USERNAME=root
   DB_PASSWORD=password
   DB_HOST=localhost
   DB_PORT=3306
   DB_NAME=vue3_project
   ```

首次启动后端服务时，会自动初始化数据库表结构和模拟数据。

## 默认账号

后端提供了两个默认账号用于测试：

- Admin账号：username=admin, password=admin（拥有所有菜单权限）
- 普通用户账号：username=xiaoxiao, password=xiaoxiao（拥有部分菜单权限）

## API文档

启动后端服务器后，可以访问以下地址查看自动生成的API文档：

- Swagger UI: http://127.0.0.1:8000/docs
- ReDoc: http://127.0.0.1:8000/redoc

## 常见问题排查

1. **后端API无法访问**
   - 确认后端服务器已启动：`python run.py`
   - 检查后端服务是否在 `http://127.0.0.1:8000` 上运行
   - 确认防火墙没有阻止连接

2. **跨域问题**
   - 后端已配置CORS，允许来自 `http://localhost:5173` 等地址的请求
   - 如果需要添加其他允许的源，请修改main.py中的`origins`列表

3. **数据结构不匹配**
   - 确保前端期望的数据结构与后端返回的数据结构一致
   - 可以通过API文档查看后端返回的数据结构

4. **数据库连接问题**
   - 确保已安装aiosqlite：`pip install aiosqlite`
   - 检查数据库文件权限是否正确

## 生产环境配置

在生产环境中，建议：

1. 修改默认账号密码
2. 使用PostgreSQL或MySQL替代SQLite
3. 配置HTTPS
4. 加强安全措施，如添加JWT认证
5. 关闭调试模式